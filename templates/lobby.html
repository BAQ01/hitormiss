{% extends "base.html" %}

{% block title %}HITORMISS â€” Lobby{% endblock %}

{% block styles %}
.lobby-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 24px;
    max-width: 400px;
    width: 90%;
}
h1 { font-size: 2rem; letter-spacing: 2px; }
.card {
    background: rgba(0,0,0,0.35);
    border-radius: 16px;
    padding: 24px;
    width: 100%;
}
.card h2 { font-size: 1.2rem; margin-bottom: 16px; }
input[type=text], input[type=url], select {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
    margin-bottom: 12px;
    background: rgba(255,255,255,0.15);
    color: white;
}
input::placeholder { color: rgba(255,255,255,0.5); }
select option { background: #191414; color: white; }
.error { color: #ff6b6b; font-size: 0.9rem; margin-top: 4px; }
/* Waiting screen */
#waiting { display: none; text-align: center; }
.pin-display {
    font-size: 3.5rem;
    font-weight: bold;
    letter-spacing: 8px;
    color: #1DB954;
    margin: 16px 0;
}
.teams-list { text-align: left; margin-top: 12px; }
.team-item {
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    font-size: 1rem;
}
{% endblock %}

{% block content %}
<div class="lobby-container">
    <h1>HITORMISS</h1>

    <!-- Kamer aanmaken -->
    <div class="card" id="create-section">
        <h2>ðŸŽ® Kamer aanmaken</h2>
        <select id="deck-mode">
            <option value="digital">Digitaal (kaartendatabase)</option>
            <option value="physical">Fysiek (QR-kaarten)</option>
        </select>
        <input type="text" id="host-team-name" placeholder="Jouw teamnaam (je doet ook mee)">
        <button class="spotify-btn" onclick="createRoom()" style="width:100%">Maak kamer</button>
        <p class="error" id="create-error"></p>
    </div>

    <!-- Wachten op spelers (na aanmaken) -->
    <div class="card" id="waiting">
        <h2>Deel deze code:</h2>
        <div class="pin-display" id="pin-display">------</div>
        <p style="opacity:0.7; font-size:0.9rem;">Teams gaan naar hitormiss.onrender.com en voeren de code in.</p>
        <div class="teams-list" id="teams-list"></div>
        <br>
        <button class="spotify-btn" id="start-btn" onclick="startGame()" style="width:100%; display:none;">
            â–¶ Start spel
        </button>
    </div>

    <!-- Joinen als team -->
    <div class="card" id="join-section">
        <h2>ðŸ‘¥ Meedoen als team</h2>
        <input type="text" id="join-pin" placeholder="6-cijferige code" maxlength="6"
               style="font-size:1.5rem; letter-spacing:4px; text-align:center;">
        <input type="text" id="team-name" placeholder="Teamnaam">
        <button class="spotify-btn" onclick="joinRoom()" style="width:100%">Doe mee</button>
        <p class="error" id="join-error"></p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script>
    const SUPABASE_URL      = "{{ supabase_url }}";
    const SUPABASE_ANON_KEY = "{{ supabase_anon_key }}";
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let hostToken = null;
    let currentRoomId = null;

    window.createRoom = async () => {
        const deckMode     = document.getElementById('deck-mode').value;
        const hostTeamName = document.getElementById('host-team-name').value.trim();
        if (!hostTeamName) {
            document.getElementById('create-error').textContent = 'Vul jouw teamnaam in.';
            return;
        }

        let resp, data;
        try {
            resp = await fetch('/room/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ deck_mode: deckMode, host_team_name: hostTeamName }),
            });
            data = await resp.json();
        } catch (err) {
            document.getElementById('create-error').textContent = 'Netwerkfout: ' + err.message;
            return;
        }
        if (!resp.ok) {
            document.getElementById('create-error').textContent =
                (data.error || 'Onbekende fout') + (data.details ? ': ' + data.details : '');
            return;
        }

        hostToken    = data.token;
        currentRoomId = data.room_id;
        localStorage.setItem('hitormiss_host_token', hostToken);
        localStorage.setItem('hitormiss_room_id',   currentRoomId);
        // Host is ook speler
        localStorage.setItem('hitormiss_team_token', data.team_token);
        localStorage.setItem('hitormiss_team_id',    data.team_id);
        localStorage.setItem('hitormiss_team_name',  hostTeamName);

        document.getElementById('create-section').style.display = 'none';
        document.getElementById('join-section').style.display   = 'none';
        document.getElementById('waiting').style.display        = 'block';
        document.getElementById('pin-display').textContent      = data.pin;

        // Realtime subscription
        supabase.channel(`lobby:${currentRoomId}`)
            .on('postgres_changes', {
                event:  'INSERT',
                schema: 'public',
                table:  'teams',
                filter: `room_id=eq.${currentRoomId}`,
            }, () => { refreshTeams(); })
            .subscribe();

        // Polling fallback (elke 3 sec)
        refreshTeams();
        setInterval(refreshTeams, 3000);
    };

    let knownTeams = new Set();

    async function refreshTeams() {
        const { data } = await supabase.from('teams').select('name').eq('room_id', currentRoomId);
        if (!data) return;
        data.forEach(t => {
            if (!knownTeams.has(t.name)) {
                knownTeams.add(t.name);
                const list = document.getElementById('teams-list');
                const div  = document.createElement('div');
                div.className = 'team-item';
                div.textContent = 'ðŸ‘¥ ' + t.name;
                list.appendChild(div);
            }
        });
        if (data.length > 0) {
            document.getElementById('start-btn').style.display = 'block';
        }
    }

    window.startGame = async () => {
        const resp = await fetch('/game/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: hostToken }),
        });
        const data = await resp.json();
        if (!resp.ok) { alert(data.error); return; }

        const pin = document.getElementById('pin-display').textContent;
        window.location.href = `/host/${pin}`;
    };

    window.joinRoom = async () => {
        const pin      = document.getElementById('join-pin').value.trim();
        const teamName = document.getElementById('team-name').value.trim();

        const resp = await fetch('/room/join', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pin, team_name: teamName }),
        });
        const data = await resp.json();
        if (!resp.ok) {
            document.getElementById('join-error').textContent = data.error;
            return;
        }

        localStorage.setItem('hitormiss_team_token',   data.token);
        localStorage.setItem('hitormiss_team_id',      data.team_id);
        localStorage.setItem('hitormiss_team_name',    data.team_name);
        localStorage.setItem('hitormiss_room_id',      data.room_id);
        window.location.href = `/controller/${pin}`;
    };
</script>
{% endblock %}
