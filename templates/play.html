{% extends "base.html" %}

{% block title %}HITORMISS - Raad het nummer{% endblock %}

{% block head %}
<script src="https://sdk.scdn.co/spotify-player.js"></script>
{% endblock %}

{% block styles %}
.game-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    max-width: 400px;
    width: 90%;
}
.album-art {
    width: 220px;
    height: 220px;
    border-radius: 14px;
    object-fit: cover;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    filter: blur(18px) brightness(0.6);
    transition: filter 0.6s ease;
}
.album-art.revealed {
    filter: none;
}
.album-placeholder {
    width: 220px;
    height: 220px;
    border-radius: 14px;
    background: rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 64px;
}
.track-info {
    text-align: center;
    line-height: 1.4;
    min-height: 52px;
}
.artist-name {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 4px;
    filter: blur(8px);
    transition: filter 0.6s ease;
    user-select: none;
}
.track-name {
    font-size: 1.05rem;
    opacity: 0.8;
    filter: blur(8px);
    transition: filter 0.6s ease;
    user-select: none;
}
.artist-name.revealed,
.track-name.revealed {
    filter: none;
    user-select: auto;
}
.status {
    font-size: 0.85rem;
    opacity: 0.65;
    min-height: 18px;
}

/* ‚îÄ‚îÄ Flip card ‚îÄ‚îÄ */
.reveal-section {
    perspective: 700px;
}
.reveal-card {
    width: 180px;
    height: 90px;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.55s ease;
    cursor: pointer;
}
.reveal-card.revealed {
    transform: rotateY(180deg);
    cursor: default;
}
.card-front,
.card-back {
    position: absolute;
    inset: 0;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
}
.card-front {
    background: rgba(255,255,255,0.12);
    border: 2px solid rgba(255,255,255,0.25);
    flex-direction: column;
    gap: 4px;
    font-size: 2rem;
}
.card-front .hint {
    font-size: 0.7rem;
    font-weight: normal;
    opacity: 0.65;
    letter-spacing: 0.5px;
}
.card-back {
    background: #1DB954;
    transform: rotateY(180deg);
    font-size: 2.6rem;
    font-weight: bold;
    letter-spacing: 2px;
}
.buttons {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    width: 100%;
}
{% endblock %}

{% block content %}
<div class="game-container">

    {% if album_art %}
    <img class="album-art" id="album-art" src="{{ album_art }}" alt="Album art">
    {% else %}
    <div class="album-placeholder">üéµ</div>
    {% endif %}

    <div class="track-info">
        <p class="artist-name" id="artist-name">{{ artist_name }}</p>
        <p class="track-name" id="track-name">{{ track_name }}</p>
    </div>

    <p class="status" id="status">Laden...</p>

    <!-- Flip card: reveals year + artist + title -->
    <div class="reveal-section">
        <div class="reveal-card" id="reveal-card" onclick="revealAll()" title="Tik om te onthullen">
            <div class="card-front">
                ‚ùì
                <span class="hint">Onthul alles</span>
            </div>
            <div class="card-back">{{ year }}</div>
        </div>
    </div>

    <a id="open-spotify-btn" href="https://open.spotify.com/track/{{ track_id }}" target="_blank"
       class="spotify-btn" style="display:none;">
        Open in Spotify
    </a>

    <div class="buttons">
        <a href="{{ url_for('scan_page') }}" class="spotify-btn">üì∑ Volgende kaart</a>
        <a href="{{ url_for('home') }}" class="btn-secondary">‚Üê Home</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const TRACK_ID     = "{{ track_id }}";
    const ACCESS_TOKEN = "{{ access_token }}";

    function revealAll() {
        document.getElementById('reveal-card').classList.add('revealed');
        document.getElementById('artist-name').classList.add('revealed');
        document.getElementById('track-name').classList.add('revealed');
        const art = document.getElementById('album-art');
        if (art) art.classList.add('revealed');
    }

    function setStatus(msg) {
        document.getElementById('status').textContent = msg;
    }

    function playTrack(deviceId) {
        const body = { track_id: TRACK_ID };
        if (deviceId) body.device_id = deviceId;

        fetch('/api/play', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'playing') {
                setStatus('‚ñ∂ Speelt af');
            } else if (data.error === 'no_device') {
                setStatus('Open Spotify op je telefoon en tik daarna hieronder:');
                document.getElementById('open-spotify-btn').style.display = 'inline-block';
            } else {
                setStatus('‚ùå Afspelen mislukt');
                document.getElementById('open-spotify-btn').style.display = 'inline-block';
                console.error('Play error:', data);
            }
        })
        .catch(err => {
            setStatus('‚ùå Verbindingsfout');
            console.error(err);
        });
    }

    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    if (isMobile) {
        // SDK werkt niet op mobiel ‚Äî direct de Spotify-app op de telefoon aansturen
        setStatus('Zoeken naar Spotify-apparaat...');
        playTrack(null);
    } else {
        // Desktop: gebruik de Web Playback SDK (speelt via browser)
        window.onSpotifyWebPlaybackSDKReady = () => {
            const player = new Spotify.Player({
                name: 'HitOrMiss',
                getOAuthToken: cb => cb(ACCESS_TOKEN),
                volume: 0.8,
            });

            player.addListener('ready', ({ device_id }) => {
                setStatus('Verbonden ‚Äî nummer laden...');
                playTrack(device_id);
            });

            player.addListener('player_state_changed', state => {
                if (state && !state.paused) setStatus('‚ñ∂ Speelt af');
            });

            player.addListener('account_error', () => { playTrack(null); });
            player.addListener('initialization_error', () => { playTrack(null); });
            player.addListener('authentication_error', () => { playTrack(null); });

            player.connect().then(success => {
                if (!success) playTrack(null);
            });
        };
    }
</script>
{% endblock %}
