{% extends "base.html" %}

{% block title %}Host â€” HITORMISS{% endblock %}

{% block head %}
<!-- Stub moet vÃ³Ã³r de SDK-script staan zodat de SDK de callback kan vinden -->
<script>
window.onSpotifyWebPlaybackSDKReady = function() {
    window._sdkReady = true;
    if (typeof window._startSDKPlayer === 'function') window._startSDKPlayer();
};
</script>
<script src="https://sdk.scdn.co/spotify-player.js"></script>
{% endblock %}

{% block styles %}
body { justify-content: flex-start; padding-top: 20px; }
.host-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    max-width: 600px;
    width: 95%;
}
.top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    background: rgba(0,0,0,0.3);
    border-radius: 12px;
    padding: 10px 16px;
    font-size: 0.95rem;
}
.pin-badge {
    font-size: 1.4rem;
    font-weight: bold;
    color: #1DB954;
    letter-spacing: 4px;
}
.teams-bar {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    width: 100%;
    justify-content: center;
}
.team-chip {
    background: rgba(255,255,255,0.12);
    border-radius: 20px;
    padding: 6px 14px;
    font-size: 0.9rem;
}
.team-chip.active { background: #1DB954; font-weight: bold; }
/* Track card */
.track-card {
    background: rgba(0,0,0,0.4);
    border-radius: 16px;
    padding: 20px;
    width: 100%;
    display: flex;
    gap: 20px;
    align-items: center;
}
.track-card img {
    width: 120px;
    height: 120px;
    border-radius: 10px;
    object-fit: cover;
}
.track-card-placeholder {
    width: 120px;
    height: 120px;
    border-radius: 10px;
    background: rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    flex-shrink: 0;
}
.track-meta { flex: 1; text-align: left; }
.track-meta .artist { font-size: 1.2rem; font-weight: bold; }
.track-meta .title  { font-size: 1rem; opacity: 0.8; margin-top: 4px; }
.track-meta .year   {
    font-size: 2rem;
    font-weight: bold;
    color: #1DB954;
    margin-top: 10px;
    display: none;
}
.status-line {
    font-size: 0.9rem;
    opacity: 0.65;
    min-height: 18px;
}
.controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; width: 100%; }
.result-banner {
    display: none;
    font-size: 1.6rem;
    font-weight: bold;
    padding: 16px 24px;
    border-radius: 12px;
    width: 100%;
    text-align: center;
}
.result-banner.correct { background: rgba(29,185,84,0.3); }
.result-banner.wrong   { background: rgba(200,0,0,0.3); }
/* Host-tijdlijn (zichtbaar als het de beurt van de host is) */
.host-timeline-section { width: 100%; display: none; }
.host-timeline-section.visible { display: block; }
.host-timeline-section h3 { font-size: 0.95rem; opacity: 0.6; margin-bottom: 8px; text-align: center; }
.host-instruction {
    text-align: center; font-size: 0.95rem; opacity: 0.85;
    padding: 8px 14px; background: rgba(29,185,84,0.12);
    border-radius: 8px; width: 100%; margin-bottom: 6px;
}
.slot-btn {
    background: rgba(29,185,84,0.12);
    border: 2px dashed rgba(29,185,84,0.5);
    border-radius: 8px; color: #1DB954;
    font-size: 1rem; cursor: pointer;
    padding: 7px; width: 100%; margin: 3px 0;
    transition: background 0.15s;
}
.slot-btn:hover  { background: rgba(29,185,84,0.3); }
.slot-btn:disabled { opacity: 0.4; cursor: default; }
.tl-card {
    background: rgba(255,255,255,0.08); border-radius: 10px;
    padding: 10px 14px; display: flex; align-items: center;
    gap: 12px; margin: 3px 0;
}
.tl-year   { font-size: 1.4rem; font-weight: bold; color: #1DB954; min-width: 54px; text-align: center; }
.tl-meta   { flex: 1; text-align: left; }
.tl-artist { font-size: 0.9rem; font-weight: bold; }
.tl-name   { font-size: 0.82rem; opacity: 0.65; }
{% endblock %}

{% block content %}
<div class="host-container">

    <!-- Top bar: PIN + beurt -->
    <div class="top-bar">
        <span>Code: <span class="pin-badge">{{ pin }}</span></span>
        <span id="turn-label" style="opacity:0.7">Wachten op start...</span>
        <span id="status-dot">â¸</span>
    </div>

    <!-- Teams -->
    <div class="teams-bar" id="teams-bar"></div>

    <!-- Actieve track -->
    <div class="track-card" id="track-card" style="display:none">
        <div class="track-card-placeholder" id="art-placeholder">ğŸµ</div>
        <img id="album-art" style="display:none" src="" alt="Album art">
        <div class="track-meta">
            <div class="artist" id="artist-name" style="filter:blur(8px)">â€”</div>
            <div class="title"  id="track-name"  style="filter:blur(8px)">â€”</div>
            <div class="year"   id="year-label">â€”</div>
        </div>
    </div>

    <p class="status-line" id="sdk-status">SDK laden...</p>

    <!-- Resultaat banner -->
    <div class="result-banner" id="result-banner"></div>

    <!-- Host tijdlijn (zichtbaar als het de beurt van de host is) -->
    <div class="host-timeline-section" id="host-timeline-section">
        <p class="host-instruction">Kies een positie voor dit nummer in jouw tijdlijn ğŸ‘‡</p>
        <div id="host-timeline"></div>
    </div>

    <!-- Bedieningsknoppen -->
    <div class="controls">
        <button class="spotify-btn" id="btn-draw"      onclick="drawCard()"    style="display:none">ğŸµ Trek kaart</button>
        <button class="spotify-btn" id="btn-pause"     onclick="togglePause()" style="display:none">â¸</button>
        <button class="spotify-btn" id="btn-reveal"    onclick="revealTrack()" style="display:none">ğŸ‘ Onthul nummer</button>
        <button class="spotify-btn" id="btn-next"      onclick="nextTurn()"    style="display:none">â¡ Volgende beurt</button>
        <a href="{{ url_for('lobby') }}" class="btn-secondary">â† Lobby</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL      = "{{ supabase_url }}";
    const SUPABASE_ANON_KEY = "{{ supabase_anon_key }}";
    const ACCESS_TOKEN      = "{{ access_token }}";
    const supabase          = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const hostToken = localStorage.getItem('hitormiss_host_token');
    const teamToken = localStorage.getItem('hitormiss_team_token');
    const teamId    = localStorage.getItem('hitormiss_team_id');
    const roomId    = localStorage.getItem('hitormiss_room_id');

    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    let sdkPlayer    = null;
    let isPlaying    = false;
    let currentTrack = null;
    let hostTimeline = [];
    let placing      = false;

    // â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const $   = id => document.getElementById(id);
    const show = id => $(id).style.display = 'block';
    const hide = id => $(id).style.display = 'none';
    const showBtn = id => $(id).style.display = 'inline-block';

    function setStatus(msg) { $('sdk-status').textContent = msg; }

    // â”€â”€ Load teams â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadTeams() {
        const { data } = await supabase.from('teams')
            .select('*').eq('room_id', roomId).order('created_at');
        renderTeams(data || [], null);
    }

    function renderTeams(teams, currentTeamId) {
        const bar = $('teams-bar');
        bar.innerHTML = '';
        teams.forEach(t => {
            const chip = document.createElement('div');
            chip.className = 'team-chip' + (t.id === currentTeamId ? ' active' : '');
            chip.textContent = t.name;
            bar.appendChild(chip);
        });
    }

    // â”€â”€ Supabase Realtime â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    supabase.channel(`host:${roomId}`)
        .on('postgres_changes', {
            event: '*', schema: 'public', table: 'game_state',
            filter: `room_id=eq.${roomId}`,
        }, async (payload) => {
            const state = payload.new;
            const { data: teams } = await supabase.from('teams')
                .select('*').eq('room_id', roomId).order('created_at');
            const currentTeam = teams?.find(t => t.id === state.current_team_id);

            renderTeams(teams || [], state.current_team_id);
            $('turn-label').textContent = currentTeam ? `Beurt: ${currentTeam.name}` : '';

            const isMyTurn = state.current_team_id === teamId;

            if (state.phase === 'idle') {
                placing = false;
                hideTrackCard();
                hide('btn-next');
                showBtn('btn-draw');
                hide('result-banner');
                $('host-timeline-section').classList.remove('visible');
            } else if (state.phase === 'placing' && state.active_track) {
                placing = false;
                currentTrack = state.active_track;
                showTrackCard(state.active_track, false);
                hide('btn-draw');
                showBtn('btn-pause');
                showBtn('btn-reveal');
                if (isMyTurn) {
                    await loadHostTimeline();
                    $('host-timeline-section').classList.add('visible');
                    hide('btn-reveal');
                } else {
                    $('host-timeline-section').classList.remove('visible');
                }
            } else if (state.phase === 'result' && state.active_track) {
                placing = false;
                showTrackCard(state.active_track, true);
                showResult(state.active_track.placement_correct);
                hide('btn-reveal');
                showBtn('btn-next');
                $('host-timeline-section').classList.remove('visible');
                if (isMyTurn) await loadHostTimeline();
            } else if (state.phase === 'finished' && state.active_track?.winner) {
                showTrackCard(state.active_track, true);
                $('result-banner').className = 'result-banner correct';
                $('result-banner').textContent = `ğŸ† ${state.active_track.winner} wint!`;
                show('result-banner');
                hide('btn-draw'); hide('btn-next'); hide('btn-pause'); hide('btn-reveal');
                $('host-timeline-section').classList.remove('visible');
            }
        })
        .subscribe();

    function showTrackCard(track, revealed) {
        show('track-card');
        $('artist-name').textContent = track.artist;
        $('track-name').textContent  = track.name;
        $('year-label').textContent  = track.year;

        if (revealed) {
            $('artist-name').style.filter = 'none';
            $('track-name').style.filter  = 'none';
            $('year-label').style.display  = 'block';
        } else {
            $('artist-name').style.filter = 'blur(8px)';
            $('track-name').style.filter  = 'blur(8px)';
            $('year-label').style.display  = 'none';
        }

        if (track.album_art) {
            $('album-art').src = track.album_art;
            show('album-art');
            hide('art-placeholder');
        }
    }

    function hideTrackCard() {
        hide('track-card');
        $('album-art').src = '';
        show('art-placeholder');
    }

    function showResult(correct) {
        const banner = $('result-banner');
        banner.className = 'result-banner ' + (correct ? 'correct' : 'wrong');
        banner.textContent = correct ? 'âœ… Correct geplaatst!' : 'âŒ Fout geplaatst!';
        show('result-banner');
    }

    // â”€â”€ Game actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.drawCard = async () => {
        hide('btn-draw');
        setStatus('Kaart trekken...');
        const resp = await fetch('/game/draw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: hostToken }),
        });
        const data = await resp.json();
        if (!resp.ok) { setStatus('âŒ ' + data.error); showBtn('btn-draw'); return; }
        // Altijd null: backend kiest echte Spotify-app (telefoon/laptop), niet de browser-SDK
        playTrack(data.track.track_id, null);
        setStatus('');
    };

    window.nextTurn = async () => {
        if (sdkPlayer) await sdkPlayer.pause().catch(() => {});
        else await fetch('/api/pause', { method: 'POST' });

        hide('btn-next'); hide('result-banner');
        await fetch('/game/next-turn', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: hostToken }),
        });
    };

    window.revealTrack = () => {
        if (!currentTrack) return;
        showTrackCard(currentTrack, true);
        hide('btn-reveal');
    };

    window.togglePause = () => {
        const btn = $('btn-pause');
        // SDK beschikbaar Ã©n op desktop (audio speelt in browser): gebruik SDK
        if (sdkPlayer && !isMobile) {
            sdkPlayer.togglePlay();
        } else {
            // Mobiel of geen SDK: gebruik REST API (audio speelt op telefoon)
            if (isPlaying) {
                fetch('/api/pause', { method: 'POST' });
                btn.textContent = 'â–¶'; isPlaying = false;
            } else {
                // Resume vanuit huidige positie (niet opnieuw starten)
                fetch('/api/resume', { method: 'POST' })
                    .then(r => r.json()).then(d => {
                        if (d.status === 'playing') {
                            isPlaying = true;
                            btn.textContent = 'â¸';
                        }
                    });
            }
        }
    };

    // â”€â”€ Spotify playback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function playTrack(trackId, deviceId) {
        const body = { track_id: trackId };
        if (deviceId) body.device_id = deviceId;
        fetch('/api/play', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        }).then(r => r.json()).then(d => {
            if (d.status === 'playing') {
                isPlaying = true;
                $('btn-pause').textContent = 'â¸';
                setStatus('â–¶ Speelt af');
            } else if (d.error === 'no_device') {
                setStatus('âš ï¸ Open Spotify op je telefoon en probeer opnieuw');
                showBtn('btn-draw');
            } else {
                setStatus('âŒ Afspelen mislukt: ' + (d.details || d.error || ''));
                showBtn('btn-draw');
            }
        });
    }

    if (isMobile) {
        // Op mobiel: sla SDK over, toon meteen de knop
        setStatus('Zorg dat Spotify open staat op dit apparaat');
        showBtn('btn-draw');
    } else {
        // Twee-fase aanpak: stub al gedefinieerd in <head> (niet-module script)
        // _startSDKPlayer wordt hier gedefinieerd en aangeroepen als SDK al klaar is
        window._startSDKPlayer = () => {
            const player = new Spotify.Player({
                name: 'HitOrMiss Host',
                getOAuthToken: cb => cb(ACCESS_TOKEN),
                volume: 0.8,
            });
            sdkPlayer = player;

            player.addListener('ready', ({ device_id }) => {
                window._sdkDeviceId = device_id;
                setStatus('Klaar om muziek af te spelen');
                showBtn('btn-draw');
            });
            player.addListener('player_state_changed', state => {
                if (!state) return;
                isPlaying = !state.paused;
                $('btn-pause').textContent = isPlaying ? 'â¸' : 'â–¶';
            });
            player.addListener('account_error',        () => { sdkPlayer = null; setStatus('âš ï¸ Geen Premium â€” gebruik Spotify-app'); showBtn('btn-draw'); });
            player.addListener('initialization_error', () => { sdkPlayer = null; setStatus('âš ï¸ SDK fout'); showBtn('btn-draw'); });
            player.addListener('authentication_error', () => { sdkPlayer = null; setStatus('âš ï¸ Auth fout'); showBtn('btn-draw'); });

            player.connect().then(success => {
                if (!success) { sdkPlayer = null; setStatus('âš ï¸ SDK verbinding mislukt'); showBtn('btn-draw'); }
            });
        };

        // Als de SDK al klaar was vÃ³Ã³r dit module-script (stub gevangen), start nu
        if (window._sdkReady) window._startSDKPlayer();
    }

    // â”€â”€ Host tijdlijn â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadHostTimeline() {
        const { data } = await supabase.from('timeline_cards')
            .select('*').eq('team_id', teamId).order('position', { ascending: true });
        hostTimeline = data || [];
        renderHostTimeline();
    }

    function renderHostTimeline() {
        const container = $('host-timeline');
        container.innerHTML = '';
        if (hostTimeline.length === 0) {
            container.appendChild(makeHostSlot(0));
            const msg = document.createElement('div');
            msg.style.cssText = 'text-align:center;opacity:0.45;font-size:0.9rem;padding:12px';
            msg.textContent = 'Tijdlijn leeg â€” eerste kaart hier plaatsen';
            container.appendChild(msg);
            return;
        }
        container.appendChild(makeHostSlot(0));
        hostTimeline.forEach((card, i) => {
            const div = document.createElement('div');
            div.className = 'tl-card';
            div.innerHTML = `<div class="tl-year">${card.year}</div>
                <div class="tl-meta"><div class="tl-artist">${card.artist_name}</div>
                <div class="tl-name">${card.track_name}</div></div>`;
            container.appendChild(div);
            container.appendChild(makeHostSlot(i + 1));
        });
    }

    function makeHostSlot(position) {
        const btn = document.createElement('button');
        btn.className = 'slot-btn';
        btn.textContent = 'ï¼‹ Hier plaatsen';
        btn.onclick = () => placeHostCard(position);
        return btn;
    }

    async function placeHostCard(position) {
        placing = true;
        document.querySelectorAll('.slot-btn').forEach(b => b.disabled = true);
        $('host-timeline-section').classList.remove('visible');
        setStatus('Plaatsing controleren...');
        const resp = await fetch('/game/place', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: teamToken, position }),
        });
        const data = await resp.json();
        if (!resp.ok) {
            placing = false;
            setStatus('âŒ ' + (data.error || 'Fout bij plaatsen'));
        }
        // Resultaat komt via Realtime
    }

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    loadTeams();
</script>
{% endblock %}
